# Подробная документация: Авторизация через Telegram

Этот документ описывает техническую реализацию авторизации пользователей через Telegram Mini Apps (TMA) в проекте «Путёвой учёт».

## 1. Официальный механизм Telegram
Для Mini Apps Telegram предоставляет данные пользователя в объекте `window.Telegram.WebApp.initData`. Это строка, содержащая параметры (`query_id`, `user`, `auth_date`, `hash`), которые необходимо проверить на сервере для подтверждения подлинности.

**Алгоритм проверки (RFC):**
1. Все ключи, кроме `hash`, сортируются в алфавитном порядке.
2. Формируется строка вида `key=value`, разделенная символом переноса строки (`\n`).
3. Генерируется секретный ключ: `HMAC-SHA256("WebAppData", bot_token)`.
4. Вычисляется `HMAC-SHA256(secret_key, data_check_string)`.
5. Полученный хэш сравнивается с переданным в `initData`.

## 2. Текущая реализация в проекте

### Фронтенд (`src/hooks/useTelegramAuth.ts`)
- Проверяет запуск в среде Telegram (`isTelegramWebApp`).
- Извлекает `initData` через `getTelegramInitData()`.
- Отправляет POST запрос на `/api/auth/telegram`.
- Сохраняет результат в `localStorage` и устанавливает состояние `user`.

### Бэкенд (`src/app/api/auth/telegram/route.ts`)
Проект использует современную библиотеку `@tma.js/init-data-node` для валидации.

- **Библиотека**: `@tma.js/init-data-node` (функции `validate` и `validate3rd`).
- **Режимы**:
  - **Старый формат**: если `initData` содержит только `hash`, используется `validate(initData, botToken)`.
  - **Новый формат**: если присутствует `signature`, используется `validate3rd(initData, botId)`, где `botId` извлекается из токена.
- **Хранение**: После валидации данные пользователя (`userData.id`) используются для синхронизации с PostgreSQL (`getUserByTelegramId`, `createUser`, `updateUser`).
- **Сессия**: Создается HTTP-only кука `auth_token` для поддержки долгосрочной сессии в браузере.

## 3. Сравнение и исправления
В ходе анализа было выявлено, что старая документация в `personal-cabinet-plan.md` описывала авторизацию исключительно через заголовок `x-telegram-id`, что является небезопасным без предварительной валидации подписи. 

**Основные отличия текущего кода от старого описания:**
- **Безопасность**: Добавлена полная HMAC-валидация `initData` на стороне сервера (ранее подразумевалось доверие заголовкам).
- **Библиотеки**: Интегрирована официальная библиотека сообщества `@tma.js`.
- **Сессии**: Внедрена поддержка JWT/Cookie сессий (`auth_token`), а не только `localStorage`.

## 4. Как проверить (Отладка)
В роуте `/api/auth/telegram` реализована диагностическая функция `debugTelegramSignature`, которая выводит в логи (`addLog`) детали проверки:
- Длину токена и данных.
- Ожидаемый хэш vs полученный.
- Результат работы `validate/validate3rd`.

---
*Документация актуализирована: 2026-01-15*
