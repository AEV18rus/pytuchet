<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Путёвой учёт</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Цветовая палитра в стиле русской бани */
            --primary-color: #4A2B1B;        /* Глубокий банный коричневый */
            --secondary-color: #7A3E2D;      /* Темный янтарно-красный */
            --accent-color: #E9D5B5;         /* Березовый бежевый */
            --background-main: #F2E5D3;      /* Теплый паровой бежевый */
            --font-color: #2C1A0F;           /* Угольно-коричневый */
            
            /* Дополнительные оттенки для интерактивности */
            --primary-light: #5D3426;        /* Светлее основного */
            --primary-dark: #3A2015;         /* Темнее основного */
            --secondary-light: #8B4A38;      /* Светлее вторичного */
            --secondary-dark: #6A3424;       /* Темнее вторичного */
            --accent-light: #F0E2C8;         /* Светлее акцентного */
            --accent-dark: #DCC49F;          /* Темнее акцентного */
            
            /* Фоновые оттенки */
            --background-card: #FEFCF8;      /* Очень светлый теплый белый */
            --background-section: rgba(233, 213, 181, 0.15); /* Полупрозрачный акцент */
            
            /* Тени и границы */
            --shadow-light: rgba(74, 43, 27, 0.1);
            --shadow-medium: rgba(74, 43, 27, 0.15);
            --border-light: rgba(74, 43, 27, 0.2);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--background-main) 0%, var(--accent-light) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--font-color);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--background-card);
            border-radius: 15px;
            box-shadow: 0 20px 40px var(--shadow-light);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: var(--accent-color);
            padding: 30px;
            text-align: center;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            flex-wrap: nowrap;
        }

        .logo {
            width: 50px;
            height: 50px;
            flex-shrink: 0;
        }

        .header-text {
            text-align: left;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .content {
            padding: 30px;
        }

        /* Секция для формы новой смены в стиле русской бани */
        .form-section {
            background: linear-gradient(135deg, var(--background-section) 0%, rgba(122, 62, 45, 0.08) 100%);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px solid var(--primary-color);
            box-shadow: 0 8px 25px var(--shadow-medium);
            position: relative;
            overflow: hidden;
        }

        .form-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        }

        .form-section h2 {
            color: var(--primary-color);
            margin-bottom: 25px;
            font-size: 1.6em;
            font-weight: 700;
            text-shadow: 0 1px 2px var(--shadow-light);
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: var(--font-color);
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-light);
            border-radius: 10px;
            font-size: 16px;
            background: var(--background-card);
            color: var(--font-color);
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px var(--shadow-light);
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(74, 43, 27, 0.1), 0 4px 12px var(--shadow-medium);
            transform: translateY(-1px);
        }

        .form-group input:hover {
            border-color: var(--primary-light);
            box-shadow: 0 4px 8px var(--shadow-light);
        }

        .form-group input:disabled {
            background: var(--accent-light);
            border-color: var(--border-light);
            color: rgba(44, 26, 15, 0.6);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 24px;
        }

        .btn {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: var(--accent-color);
            border: none;
            padding: 16px 32px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px var(--shadow-medium);
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(74, 43, 27, 0.4);
            background: linear-gradient(135deg, var(--primary-light) 0%, var(--secondary-light) 100%);
        }

        .btn:active {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px var(--shadow-medium);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #5a6268 0%, #343a40 100%);
        }

        .pricing-section {
            margin-top: 20px;
            text-align: center;
        }

        .pricing-section .btn {
            max-width: 200px;
            margin: 0 auto;
        }

        .btn:disabled {
            background: var(--accent-dark);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.6;
        }



        .shifts-list {
            background: rgba(240, 226, 200, 0.3);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid var(--border-light);
            box-shadow: 0 2px 10px var(--shadow-light);
        }

        .shifts-list h2 {
            color: var(--font-color);
            margin-bottom: 20px;
            font-size: 1.4em;
            font-weight: 600;
        }

        .shifts-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--background-card);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px var(--shadow-light);
        }

        .shifts-table th {
            background: linear-gradient(135deg, var(--secondary-color) 0%, rgba(122, 62, 45, 0.8) 100%);
            color: white;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .shifts-table td {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-light);
            color: var(--font-color);
            font-size: 0.95em;
        }

        .shifts-table tr:hover {
            background: rgba(240, 226, 200, 0.3);
        }

        .shifts-table tr:last-child td {
            border-bottom: none;
        }

        .delete-btn {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .delete-btn:hover {
            background: linear-gradient(135deg, #c53030 0%, #9c2626 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(197, 48, 48, 0.3);
        }

        .delete-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(197, 48, 48, 0.3);
        }

        .delete-btn-small {
            background: #e53e3e;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .delete-btn-small:hover {
            background: #c53030;
            transform: scale(1.1);
        }



        .empty-state {
            text-align: center;
            color: var(--font-color);
            font-style: italic;
            padding: 40px;
            opacity: 0.7;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header-content {
                gap: 15px;
                flex-wrap: nowrap;
            }
            
            .logo {
                width: 120px;
                height: 120px;
            }
            
            .header-text {
                text-align: left;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .content {
                padding: 20px;
            }
            
            .form-section, .shifts-list {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <img src="public/logo.svg" alt="Логотип" class="logo">
                <div class="header-text">
                    <h1>Путёвой учёт</h1>
                    <p>Система учета рабочих смен и услуг</p>
                </div>
            </div>
        </div>

        <div class="content">
            <!-- Форма новой смены -->
            <div class="form-section">
                <h2>Новая смена</h2>
                <form id="shiftForm">
                    <div class="form-group">
                        <label for="date">Дата смены:</label>
                        <input type="date" id="date" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="hours">Отработанные часы:</label>
                            <input type="number" id="hours" min="0" step="0.5" placeholder="8" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="steamBath">Путевое парение (кол-во):</label>
                            <input type="number" id="steamBath" min="0" placeholder="0">
                        </div>
                        
                        <div class="form-group">
                            <label for="brandSteam">Фирменное парение (кол-во):</label>
                            <input type="number" id="brandSteam" min="0" placeholder="0">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="introSteam">Ознакомительное парение (кол-во):</label>
                            <input type="number" id="introSteam" min="0" placeholder="0">
                        </div>
                        
                        <div class="form-group">
                            <label for="scrubbing">Скрабирование (кол-во):</label>
                            <input type="number" id="scrubbing" min="0" placeholder="0">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="masters">Кол-во мастеров:</label>
                        <input type="number" id="masters" min="1" placeholder="1" required>
                    </div>
                    
                    <button type="submit" class="btn">Добавить смену</button>
                </form>
            </div>

            <!-- Кнопка управления ценами -->
            <div class="pricing-section">
                <button type="button" class="btn btn-secondary" onclick="openPricingPage()">Прайс</button>
            </div>



            <!-- Список смен -->
            <div class="shifts-list">
                <h2>История смен</h2>
                <div id="shiftsList"></div>
            </div>
        </div>
    </div>

    <script>
        // Инициализация данных
        let shifts = [];

        // API базовый URL
        const API_BASE = 'http://localhost:3000/api';

        // Установка текущей даты
        document.getElementById('date').valueAsDate = new Date();

        // Загрузка и отображение актуальных цен
        async function loadAndDisplayPrices() {
            try {
                const response = await fetch(`${API_BASE}/prices`);
                if (response.ok) {
                    const prices = await response.json();
                    displayPricesInForm(prices);
                } else {
                    console.error('Ошибка загрузки цен:', response.statusText);
                    // Fallback к localStorage
                    const savedPrices = JSON.parse(localStorage.getItem('servicePrices') || '{}');
                    displayPricesInForm({
                        hourly_rate: savedPrices.hourlyRate || 400,
                        steam_bath_price: savedPrices.steamBathPrice || 3500,
                        brand_steam_price: savedPrices.brandSteamPrice || 4200,
                        intro_steam_price: savedPrices.introSteamPrice || 2500,
                        scrubbing_price: savedPrices.scrubbingPrice || 1200
                    });
                }
            } catch (error) {
                console.error('Ошибка подключения к серверу:', error);
                // Fallback к localStorage
                const savedPrices = JSON.parse(localStorage.getItem('servicePrices') || '{}');
                displayPricesInForm({
                    hourly_rate: savedPrices.hourlyRate || 400,
                    steam_bath_price: savedPrices.steamBathPrice || 3500,
                    brand_steam_price: savedPrices.brandSteamPrice || 4200,
                    intro_steam_price: savedPrices.introSteamPrice || 2500,
                    scrubbing_price: savedPrices.scrubbingPrice || 1200
                });
            }
        }

        // Отображение цен в форме
        function displayPricesInForm(prices) {
            // Обновляем лейблы с ценами
            const labels = {
                'hours': `Отработанные часы (${prices.hourly_rate} ₽/час):`,
                'steamBath': `Путевое парение (${prices.steam_bath_price} ₽):`,
                'brandSteam': `Фирменное парение (${prices.brand_steam_price} ₽):`,
                'introSteam': `Ознакомительное парение (${prices.intro_steam_price} ₽):`,
                'scrubbing': `Скрабирование (${prices.scrubbing_price} ₽):`
            };

            Object.keys(labels).forEach(fieldId => {
                const label = document.querySelector(`label[for="${fieldId}"]`);
                if (label) {
                    label.innerHTML = labels[fieldId];
                }
            });
        }

        // Функция открытия страницы с ценами
        function openPricingPage() {
            window.open('pricing.html', '_blank');
        }

        // Загрузка смен из базы данных
        async function loadShifts() {
            try {
                const response = await fetch(`${API_BASE}/shifts`);
                if (response.ok) {
                    shifts = await response.json();
                    updateDisplay();
                } else {
                    console.error('Ошибка загрузки смен:', response.statusText);
                    // Fallback к localStorage если сервер недоступен
                    shifts = JSON.parse(localStorage.getItem('shifts') || '[]');
                    updateDisplay();
                }
            } catch (error) {
                console.error('Ошибка подключения к серверу:', error);
                // Fallback к localStorage если сервер недоступен
                shifts = JSON.parse(localStorage.getItem('shifts') || '[]');
                updateDisplay();
            }
        }

        // Обработчик формы
        document.getElementById('shiftForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const shiftData = {
                date: document.getElementById('date').value,
                hours: parseFloat(document.getElementById('hours').value) || 0,
                steamBath: parseInt(document.getElementById('steamBath').value) || 0,
                brandSteam: parseInt(document.getElementById('brandSteam').value) || 0,
                introSteam: parseInt(document.getElementById('introSteam').value) || 0,
                scrubbing: parseInt(document.getElementById('scrubbing').value) || 0,
                masters: parseInt(document.getElementById('masters').value) || 1
            };
            
            try {
                const response = await fetch(`${API_BASE}/shifts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(shiftData)
                });
                
                if (response.ok) {
                    const newShift = await response.json();
                    shifts.unshift(newShift); // Добавляем в начало массива
                    updateDisplay();
                    
                    // Очистка формы
                    this.reset();
                    document.getElementById('date').valueAsDate = new Date();
                    
                    alert('Смена успешно добавлена!');
                } else {
                    alert('Ошибка при сохранении смены');
                }
            } catch (error) {
                console.error('Ошибка:', error);
                // Fallback к localStorage
                const shift = {
                    id: Date.now(),
                    ...shiftData
                };
                shifts.push(shift);
                localStorage.setItem('shifts', JSON.stringify(shifts));
                updateDisplay();
                
                // Очистка формы
                this.reset();
                document.getElementById('date').valueAsDate = new Date();
                
                alert('Смена сохранена локально (сервер недоступен)');
            }
        });

        // Удаление смены
        async function deleteShift(id) {
            if (confirm('Удалить эту смену?')) {
                try {
                    const response = await fetch(`${API_BASE}/shifts/${id}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        shifts = shifts.filter(shift => shift.id !== id);
                        updateDisplay();
                    } else {
                        alert('Ошибка при удалении смены');
                    }
                } catch (error) {
                    console.error('Ошибка:', error);
                    // Fallback к localStorage
                    shifts = shifts.filter(shift => shift.id !== id);
                    localStorage.setItem('shifts', JSON.stringify(shifts));
                    updateDisplay();
                }
            }
        }

        // Обновление отображения
        function updateDisplay() {
            updateShiftsList();
        }

        // Расчет суммы для смены
        // Обновление списка смен
        function updateShiftsList() {
            const shiftsList = document.getElementById('shiftsList');
            
            if (shifts.length === 0) {
                shiftsList.innerHTML = '<div class="empty-state">Пока нет добавленных смен</div>';
                return;
            }

            const sortedShifts = [...shifts].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            shiftsList.innerHTML = `
                <table class="shifts-table">
                    <thead>
                        <tr>
                            <th>Дата</th>
                            <th>Сумма</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedShifts.map(shift => `
                            <tr>
                                <td>${formatDateShort(shift.date)}</td>
                                <td>${shift.total || 0} ₽</td>
                                <td><button class="delete-btn-small" onclick="deleteShift(${shift.id})">×</button></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Форматирование даты
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        // Короткое форматирование даты для таблицы
        function formatDateShort(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ru-RU', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Обработчик сообщений от страницы с ценами
        window.addEventListener('message', function(event) {
            if (event.data.type === 'pricesUpdated') {
                // Обновить отображение смен с новыми ценами
                updateShiftsList();
            }
        });

        // Инициализация при загрузке
        loadShifts();
        loadAndDisplayPrices();
    </script>
</body>
</html>