# ТЗ и ToDo по проекту «Путёвой учёт» (Next.js + PostgreSQL + Telegram WebApp)

Документ описывает, **что** делает система, **как** она устроена технически и **какими шагами** любой разработчик может полностью её развернуть и повторить.

---

## 1. Назначение проекта

Система «Путёвой учёт» — это веб-приложение для бани/студии, которое:

- собирает и хранит смены мастеров (часы работы + услуги);
- считает выработку и суммы выплат по фиксированным ставкам;
- показывает мастерам личный кабинет с их сменами и выплатами;
- даёт администратору панель для контроля по месяцам: кто сколько отработал, кому сколько платить, статус месяца (закрыт/выплачен);
- интегрируется с Telegram:
  - мастер может заходить через Telegram WebApp;
  - есть fallback вход по логину/паролю через браузер.

Проект реализован как **Next.js 16 приложение** с App Router, серверными API-роутами и базой данных PostgreSQL (локальной или Vercel Postgres). Отдельно есть простой Node-бот для Telegram. 

---

## 2. Роли пользователей и сценарии

### 2.1. Роли

- **master** — мастер (банщик / специалист):
  - видит свои смены и выплаты;
  - может авторизоваться через Telegram и/или через логин/пароль;
- **admin** — администратор/владелец:
  - имеет доступ к админ-панели;
  - видит всех пользователей, их смены, месячные итоги и выплаты;
  - управляет ценами, может создавать тестовые данные, чинить схему;
- **demo** — демо/тестовый пользователь (если используется):
  - может использоваться для демонстрации без реальных данных.

Роль хранится в таблице `users.role`. 

### 2.2. Основные пользовательские сценарии

#### Мастер

1. Получает ссылку на Telegram-бота или WebApp.
2. Нажимает кнопку «Открыть WebApp» → открывается сайт `https://.../`.
3. Telegram передаёт `initData` → backend создаёт/обновляет пользователя в таблице `users`.
4. Мастер попадает на главную / личный кабинет:
   - видит приветствие с именем;
   - видит свои смены и суммы по месяцам;
   - может задать логин/пароль для входа через браузер (страница `/account`). 

#### Администратор

1. Заходит на сайт по адресу `/login` и вводит логин/пароль (cookie-сессия).
2. После входа видит админскую страницу `/admin`:
   - аккордеоны/блоки: пользователи, смены, выплаты, месячные итоги, отчёты, логи.
3. Может:
   - смотреть список пользователей (`/api/users`);
   - смотреть смены по пользователю и по месяцам (`/api/reports`, `/api/admin/reports`);
   - считать выплаты по выбранному месяцу, отмечать месяц оплаченным (`month_status`, `payouts`);
   - управлять прайсом через страницу `/pricing` и API `/api/prices`. 

#### Общие сценарии

- Регистрация/обновление профиля:
  - страница `/register` — установка «человеческого имени» (`display_name`) поверх данных Telegram; 
- Установка логина/пароля для браузера:
  - страница `/account` + API `/api/user/set-password`:
    - валидирует текущий пароль (если он уже есть);
    - хеширует новый пароль (`password_hash`);
    - сохраняет `browser_login` и время установки `password_set_at`. 
- Просмотр прайс-листа:
  - страница `/pricing`, данные из таблиц `prices / default_prices`.

---

## 3. Архитектура системы

### 3.1. Фронтенд (Next.js 16)

- Framework: **Next.js 16** (App Router).  
- Ядро:
  - `src/app/page.tsx` — главная страница;
  - `src/app/login/page.tsx` — форма логина по логин/пароль;
  - `src/app/payouts/page.tsx` — раздел выплат/смен;
  - `src/app/pricing/page.tsx` — прайс;
  - `src/app/account/page.tsx` — личный кабинет и настройки профиля; 
- UI:
  - компоненты в `src/components/ui`: `Card`, `Button`, `Input`, `Select` и т.п.; 
  - общие компоненты:
    - `Navigation.tsx` — навигация (Главная / Прайс / Вход / ЛК);
    - `PaymentsList.tsx`, `NewPaymentForm.tsx` — работа с выплатами;
    - `TelegramWebApp.tsx` — обёртка для работы внутри Telegram WebApp;
    - `UserManagement.tsx`, `VersionDisplay.tsx`, `Toast.tsx` и др. 
- Хуки:
  - `useTelegramAuth` — достаёт пользователя из Telegram initData или cookie-сессии и даёт объект `user` + `loading`. 

### 3.2. Бэкенд (API + БД)

- Все API-роуты находятся в `src/app/api/**/route.ts`.  
  Ключевые группы:
  - `/api/auth/*` — логин, логаут, `me`, `telegram`;
  - `/api/user/*` — профиль, регистрация, установка пароля;
  - `/api/payouts/*` — данные по выплатам и месяцам;
  - `/api/shifts/*` — CRUD по сменам;
  - `/api/prices/*` — цены;
  - `/api/admin/*` — служебные админские эндпоинты;
  - `/api/telegram-webhook` — вход точка для Telegram Webhook;
  - `/api/version` — отдаёт версию из `version.json`. 

- Работа с базой:
  - модуль `src/lib/db.ts`:
    - переключение между **локальным PostgreSQL** (`pg.Pool` + `DATABASE_URL`) и **Vercel Postgres** (`@vercel/postgres`), в зависимости от наличия переменных окружения и флага `VERCEL`; 
  - модуль `src/lib/startup.ts` + `src/lib/global-init.ts`:
    - инициализация базы при старте приложения;
    - создание таблиц через `init-vercel-postgres.js` / SQL для локального режима.

### 3.3. База данных

**Схема для локальной разработки (scripts/init-local-postgres.sql):**

- `users`
  - `id` SERIAL PK;
  - `telegram_id` BIGINT UNIQUE;
  - `first_name`, `last_name`, `username`, `display_name`;
  - `role` (по умолчанию `'master'`);
  - `browser_login`, `password_hash`, `password_set_at`;
  - `last_login_at`, `is_blocked`, `blocked_at`;
  - `created_at`, `updated_at`.
  - Индекс `idx_users_browser_login` (уникальный логин, несколько `NULL` разрешены).

- `shifts`
  - `id` SERIAL PK;
  - `user_id` → `users.id` (ON DELETE CASCADE);
  - `date` (текстовая дата, YYYY-MM-DD);
  - `hours` (отработанные часы);
  - счётчики услуг:
    - `steam_bath`, `brand_steam`, `intro_steam`, `scrubbing`, (плюс `zaparnik` в Vercel-варианте);
  - `masters` (количество мастеров);
  - `total` — итоговая сумма;
  - `hourly_rate`, `steam_bath_price`, `brand_steam_price`,
    `intro_steam_price`, `scrubbing_price`, `zaparnik_price`.

- `prices`
  - `id` SERIAL PK;
  - `name` (уникальное название услуги);
  - `price` (стоимость);
  - `updated_at`.

- `default_prices`
  - базовый набор цен:
    - Почасовая ставка, Путевое парение, Фирменное, Ознакомительное, Скрабирование.

**Дополнительные таблицы (через JS-скрипты инициализации):** 

- `payouts`
  - выплаты по мастерам/месяцам;
- `month_status`
  - статус месяца: закрыт ли, выплачен ли;
- другие служебные таблицы (если создаются скриптами).

### 3.4. Telegram-интеграция

- **Webhook-роут**: `/api/telegram-webhook`:
  - принимает POST-запросы от Telegram;
  - обрабатывает команды и/или нажатия кнопок;
  - инициирует авторизацию/создание пользователя и открытие WebApp. 
- **Скрипт `scripts/setup-telegram-webhook.js`:**
  - команды:
    - `npm run webhook:set`
    - `npm run webhook:info`
    - `npm run webhook:delete` 
  - использует токен бота и URL вебхука из `.env.local`.
- **Папка `telegram-bot/`:**
  - отдельный бот на `node-telegram-bot-api` с поддержкой:
    - polling (локальная разработка);
    - webhook (продакшн);
  - читает `BOT_TOKEN`, `WEBHOOK_URL`, `USE_WEBHOOK`, `PORT` из `.env`.

---

## 4. Нефункциональные требования

- Язык интерфейса: русский.
- Производительность:
  - база данных рассчитана на десятки пользователей и сотни/тысячи смен без оптимизаций;
  - используется ленивое создание таблиц и минимальные индексы.
- Безопасность:
  - вход по Telegram initData (проверка подписи);
  - вход по логину/паролю с хешированием пароля (`password_hash`);
  - cookie-сессия (`auth_token`) с секретом окружения; 
- Развёртывание:
  - продакшн — Vercel + Vercel Postgres;
  - локальная разработка — локальный PostgreSQL + `DATABASE_URL`.

---

## 5. Требования к окружению

### 5.1. Локальная разработка

- Node.js 18+;
- npm или pnpm;
- PostgreSQL 14+;
- установленный git;
- Telegram-аккаунт для создания бота.

### 5.2. Переменные окружения (примерный список)

В файле `.env.local` (локально) и в настройках Vercel:

- Параметры БД:
  - `DATABASE_URL` — строка подключения к локальному PostgreSQL;
  - для Vercel: `POSTGRES_URL` / `POSTGRES_URL_NON_POOLING` и др. (генерируются Vercel Postgres).
- Авторизация:
  - `AUTH_COOKIE_SECRET` — секрет для подписи cookie-сессии.
- Telegram:
  - `TELEGRAM_BOT_TOKEN` или `BOT_TOKEN` — токен бота;
  - `TELEGRAM_BOT_USERNAME` — username бота;
  - `TELEGRAM_WEBHOOK_SECRET` (если используется) — секрет для проверки webhook;
  - `WEBHOOK_URL` — публичный URL webhook (продакшн).
- Общее:
  - `NEXT_PUBLIC_WEBSITE_URL` или аналог — базовый URL сайта в продакшн;
  - при необходимости: `ADMIN_TELEGRAM_ID` для автосоздания админа.

(Точные имена могут отличаться — их нужно сверить по обращению к `process.env` в коде проекта.)

---

## 6. ToDo: как повторить проект с нуля

Ниже — чек-лист в логическом порядке, который позволяет любому разработчику развернуть систему с нуля.

### 6.1. Подготовка репозитория

- [ ] Установить Node.js 18+ и PostgreSQL.
- [ ] Склонировать репозиторий проекта:
  - `git clone <URL>`;  
  - `cd pytuchet-nextjs` (имя папки взять из реального проекта).
- [ ] Установить зависимости:
  - `npm install`.

### 6.2. Настройка локальной базы PostgreSQL

- [ ] Создать локальную базу данных (например, `pytuchet_local`):
  - через `createdb pytuchet_local` или GUI.
- [ ] Сформировать `DATABASE_URL`, например:
  - `postgres://user:password@localhost:5432/pytuchet_local`.
- [ ] Создать файл `.env.local` в корне проекта и прописать:
  - `DATABASE_URL=postgres://...`
  - временные значения для `AUTH_COOKIE_SECRET` и Telegram-переменных.
- [ ] Выполнить SQL-инициализацию:
  - открыть `scripts/init-local-postgres.sql`;
  - выполнить его через `psql`:
    - `psql -d pytuchet_local -f scripts/init-local-postgres.sql`.
- [ ] Убедиться, что таблицы `users`, `shifts`, `prices`, `default_prices` созданы.

### 6.3. Создание тестовых данных

- [ ] Проверить наличие скриптов в `scripts/`:
  - `create-test-user.js`;
  - `create-test-data.js`;
  - при необходимости — `create-fallback-user.js`. 
- [ ] Выполнить:
  - `node scripts/create-test-user.js` — создать тестового пользователя (обычно admin/master);
  - `node scripts/create-test-data.js` — накидать тестовых смен/выплат.
- [ ] Проверить в базе наличие хотя бы одного пользователя и нескольких смен.

### 6.4. Запуск локального сервера Next.js

- [ ] Запустить dev-сервер:
  - `npm run dev`.
- [ ] Открыть `http://localhost:3000/`:
  - проверить загрузку главной страницы;
  - открыть `/login`, `/payouts`, `/pricing`, `/account`. 
- [ ] При необходимости:
  - выполнить `npm run init-postgres` или `npm run init-vercel` для выравнивания схемы с Vercel-вариантом (добавление `zaparnik` и т.п.). 

### 6.5. Настройка авторизации по логину/паролю

- [ ] Убедиться, что у тестового пользователя есть `telegram_id` и он существует в таблице `users`.
- [ ] Зайти на `/account` под авторизованным пользователем (через имитацию Telegram или временные заголовки `x-telegram-id` на API).
- [ ] На странице `/account`:
  - задать `display_name`;
  - задать `browser_login` + пароль (через форму и `/api/user/set-password`). 
- [ ] Выйти и войти через `/login`:
  - проверить, что логин/пароль работают, cookie-сессия создаётся, `/api/auth/me` возвращает `authenticated: true`. 

### 6.6. Настройка Telegram-бота

- [ ] Создать бота у `@BotFather`:
  - получить токен `TELEGRAM_BOT_TOKEN`;
  - задать `BOT_USERNAME`.
- [ ] В `.env.local` прописать:
  - `BOT_TOKEN=<токен>`;
  - `USE_WEBHOOK=false` (на первом этапе для polling);
  - `PORT=3500` (если нужно).
- [ ] Перейти в папку `telegram-bot/`:
  - `cd telegram-bot`;
  - `npm install`.
- [ ] Запустить бота в polling-режиме:
  - `node bot.js`;
- [ ] В Telegram написать боту `/start`:
  - убедиться, что бот отвечает и предлагает ссылку/кнопку на WebApp (`https://localhost:3000` или реальный URL).

### 6.7. Vercel + Vercel Postgres (продакшн)

- [ ] Создать аккаунт и проект в Vercel.
- [ ] Подключить репозиторий к Vercel:
  - выбрать этот проект как Next.js приложение.
- [ ] Добавить Vercel Postgres:
  - через раздел Storage → Postgres;
  - получить `POSTGRES_URL`, `POSTGRES_URL_NON_POOLING` и т.д.
- [ ] В настройках Environment Variables Vercel указать:
  - все необходимые переменные (`POSTGRES_*`, `AUTH_COOKIE_SECRET`, `TELEGRAM_*`, `NEXT_PUBLIC_WEBSITE_URL` и т.п.).
- [ ] Задеплоить проект:
  - дождаться успешного билда;
  - открыть `https://<project>.vercel.app/test.html` — там есть тестовая страница развёртывания;
  - проверить `/api/hello`, `/api/version`.
- [ ] Выполнить инициализацию схемы Vercel Postgres:
  - `npm run init-vercel` (локально с `.env.local`, указывающим Vercel Postgres);
  - либо вызывать `/api/init-db` (если предусмотрено).

### 6.8. Перевод Telegram на Webhook (продакшн)

- [ ] В `.env.local` (или в переменных сервера бота) прописать:
  - `USE_WEBHOOK=true`;
  - `WEBHOOK_URL=https://<project>.vercel.app/api/telegram-webhook` (или свой домен).
- [ ] Выполнить:
  - `npm run webhook:set` — зарегистрировать URL вебхука в Telegram;
  - `npm run webhook:info` — проверить статус;
  - при необходимости `npm run webhook:delete` — сбросить настройки. 
- [ ] Перезапустить бота/приложение, если нужно.
- [ ] Проверить:
  - отправить `/start` боту;
  - убедиться, что запросы приходят в `/api/telegram-webhook`;
  - WebApp открывается уже с продакшн-адреса.

### 6.9. Настройка ролей и админ-панели

- [ ] В базе данных:
  - найти запись пользователя, который будет админом;
  - установить ему `role='admin'`.
- [ ] Зайти на `/login` с его логином/паролем.
- [ ] Проверить доступ к `/admin`:
  - увидеть блоки: пользователи, смены, месячные итоги, выплаты, отчёты, логи (интерфейс зависит от текущей реализации). 
- [ ] Создать/отредактировать прайс:
  - через `/pricing` и `/api/prices` (если реализован UI редактирования).

### 6.10. Проверка бизнес-логики и отчётов

- [ ] Через API или UI создать несколько смен для разных мастеров:
  - даты в одном и нескольких месяцах;
  - разный набор услуг (`steam_bath`, `brand_steam`, `intro_steam`, `scrubbing`, `zaparnik`). 
- [ ] Проверить:
  - `/api/reports` и `/api/admin/reports`:
    - суммы по месяцам и по мастерам;
  - `/api/admin/month-totals`:
    - общую сумму по месяцу;
  - `/api/payouts`:
    - создаются ли записи выплат;
    - корректно ли считаются исправления/доначисления (если реализовано).
- [ ] В админ-панели:
  - закрыть месяц (обновить `month_status`);
  - сверить суммы выплат с ожиданиями.

### 6.11. Финальные шаги и эксплуатация

- [ ] Обновить `version.json` (если используется) перед релизом.
- [ ] Проверить:
  - авторизацию по Telegram и логин/пароль;
  - страницы `/`, `/payouts`, `/pricing`, `/account`, `/admin`;
  - корректный таймзон и формат дат.
- [ ] Задокументировать:
  - как добавлять нового мастера;
  - как закрывать месяц;
  - как выгружать данные для бухгалтерии (из `/api/reports` или интерфейса).
- [ ] Настроить резервное копирование базы PostgreSQL (средствами Vercel Postgres или собственного хоста).
- [ ] По необходимости — добавить мониторинг (логирование ошибок через `src/lib/logging.ts` + внешние сервисы). 

---

Этот документ можно положить в корень проекта как `TECH_SPEC_TODO.md` и использовать как инструкцию-чеклист: пройтись по блокам 6.1–6.11 подряд, и в конце вы получите полностью работающее приложение «Путёвой учёт» с локальной и продакшн-инфраструктурой.
